# ===================================================================
# Docker Compose - Full Stack Application
# ===================================================================
# Services: Frontend, Gateway, Product Service, Order Service, Keycloak, Databases
# ===================================================================

services:
  # =================================================================
  # PostgreSQL Database for Products
  # =================================================================
  postgres-product:
    image: postgres:16-alpine
    container_name: postgres-product
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5433:5432"
    volumes:
      - postgres-product-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d product_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =================================================================
  # PostgreSQL Database for Orders
  # =================================================================
  postgres-order:
    image: postgres:16-alpine
    container_name: postgres-order
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5434:5432"
    volumes:
      - postgres-order-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d order_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =================================================================
  # PostgreSQL Database for Keycloak
  # =================================================================
  postgres-keycloak:
    image: postgres:16-alpine
    container_name: postgres-keycloak
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
    ports:
      - "5435:5432"
    volumes:
      - postgres-keycloak-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U myuser -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =================================================================
  # Keycloak Identity Provider
  # =================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.0
    container_name: keycloak-service
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres-keycloak:5432/keycloak
      KC_DB_USERNAME: myuser
      KC_DB_PASSWORD: mypassword
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
    ports:
      - "9090:8080"
    volumes:
      - ./keycloack/configuration/realm.json:/opt/keycloak/data/import/realm.json
    networks:
      - app-network
    depends_on:
      postgres-keycloak:
        condition: service_healthy

  # =================================================================
  # Product Microservice
  # =================================================================
  product-service:
    build:
      context: ./server/product-service
      dockerfile: Dockerfile
    container_name: product-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-product:5432/product_db
      SPRING_DATASOURCE_USERNAME: myuser
      SPRING_DATASOURCE_PASSWORD: mypassword
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/eshop-realm
      SERVER_PORT: 8081
    ports:
      - "8081:8081"
    networks:
      - app-network
    depends_on:
      postgres-product:
        condition: service_healthy
      keycloak:
        condition: service_started
    restart: on-failure

  # =================================================================
  # Order Microservice
  # =================================================================
  order-service:
    build:
      context: ./server/order-service
      dockerfile: Dockerfile
    container_name: order-service
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-order:5432/order_db
      SPRING_DATASOURCE_USERNAME: myuser
      SPRING_DATASOURCE_PASSWORD: mypassword
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/eshop-realm
      APPLICATION_CONFIG_PRODUCT_SERVICE_URL: http://gateway-service:8080/api/products
      SERVER_PORT: 8082
    ports:
      - "8082:8082"
    networks:
      - app-network
    depends_on:
      postgres-order:
        condition: service_healthy
      keycloak:
        condition: service_started
      product-service:
        condition: service_started
    restart: on-failure

  # =================================================================
  # API Gateway Service
  # =================================================================
  gateway-service:
    build:
      context: ./server/gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    environment:
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://keycloak:8080/realms/eshop-realm
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_0_ID: product-service
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_0_URI: http://product-service:8081
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_0_PREDICATES_0: Path=/api/products/**
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_1_ID: order-service
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_1_URI: http://order-service:8082
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_1_PREDICATES_0: Path=/api/orders/**
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_2_ID: product-service-docs
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_2_URI: http://product-service:8081
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_2_PREDICATES_0: Path=/product-service/v3/api-docs/**
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_2_FILTERS_0: RewritePath=/product-service/(?<path>.*), /$\{path}
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_3_ID: order-service-docs
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_3_URI: http://order-service:8082
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_3_PREDICATES_0: Path=/order-service/v3/api-docs/**
      SPRING_CLOUD_GATEWAY_SERVER_WEBMVC_ROUTES_3_FILTERS_0: RewritePath=/order-service/(?<path>.*), /$\{path}
      SERVER_PORT: 8080
    ports:
      - "8080:8080"
    networks:
      - app-network
    depends_on:
      - product-service
      - order-service
      - keycloak
    restart: on-failure

  # =================================================================
  # Frontend React Application
  # =================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: http://localhost:8080
        REACT_APP_KEYCLOAK_URL: http://localhost:9090
        REACT_APP_KEYCLOAK_REALM: eshop-realm
        REACT_APP_KEYCLOAK_CLIENT_ID: react-frontend
    container_name: frontend
    ports:
      - "3000:80"
    networks:
      - app-network
    depends_on:
      - gateway-service

# =================================================================
# Networks
# =================================================================
networks:
  app-network:
    driver: bridge

# =================================================================
# Volumes for data persistence
# =================================================================
volumes:
  postgres-product-data:
  postgres-order-data:
  postgres-keycloak-data:
