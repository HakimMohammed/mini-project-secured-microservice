# ===================================================================
# Docker Compose - DevSecOps Tools
# ===================================================================
# This file adds security scanning tools to your infrastructure
# Run with: docker-compose -f docker-compose.services.yml -f docker-compose.devsecops.yml up -d
# ===================================================================

services:
  # =================================================================
  # SonarQube - Static Code Analysis
  # new password: admin123
  # =================================================================
  sonarqube:
    image: sonarqube:10.3-community
    container_name: sonarqube
    environment:
      SONAR_JDBC_URL: jdbc:postgresql://host.docker.internal:5432/sonarqube
      SONAR_JDBC_USERNAME: myuser
      SONAR_JDBC_PASSWORD: mypassword
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: "true"
    ports:
      - "9000:9000"
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
    restart: unless-stopped

  # =================================================================
  # OWASP Dependency-Check Database
  # =================================================================
  dependency-check:
    image: owasp/dependency-check:latest
    container_name: dependency-check
    environment:
      NVD_API_KEY: ${NVD_API_KEY}
    volumes:
      - ./devsecops/security-reports:/report
      - ./server:/src
      - dependency_check_data:/usr/share/dependency-check/data
    command: >
      --scan /src
      --format ALL
      --project "EShop-Microservices"
      --out /report/dependency-check
      --nvdApiKey ${NVD_API_KEY}
      --enableExperimental
    networks:
      - app-network
    profiles:
      - scan

  # =================================================================
  # Trivy - Docker Image Scanner
  # =================================================================
  trivy:
    image: aquasec/trivy:latest
    container_name: trivy-scanner
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./devsecops/security-reports:/reports
      - trivy_cache:/root/.cache
    command: ["--help"]
    networks:
      - app-network
    profiles:
      - scan

# =================================================================
# Volumes
# =================================================================
volumes:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_extensions:
  dependency_check_data:
  trivy_cache:

# =================================================================
# Networks
# =================================================================
networks:
  app-network:
    external: true